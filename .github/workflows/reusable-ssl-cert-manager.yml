# .github/workflows/reusable-ssl-cert-manager.yml
# --- å¯å¤ç”¨å·¥ä½œæµ (SSL è¯ä¹¦ç®¡ç†å·¥å…· - CertGuard) ---
# ä½¿ç”¨æ–°çš„ SSL è¯ä¹¦ç®¡ç†å·¥å…·è¿›è¡Œè¯ä¹¦æ£€æŸ¥å’Œç»­ç­¾

name: 'Reusable: SSL è¯ä¹¦ç®¡ç†å·¥å…· - CertGuard'

on:
  workflow_call:
    inputs:
      server_name:
        description: 'æœåŠ¡å™¨çš„åç§°'
        required: true
        type: string
      domain:
        description: 'æŒ‡å®šåŸŸå (å¯é€‰ï¼Œç•™ç©ºåˆ™æ£€æŸ¥æ‰€æœ‰åŸŸå)'
        required: false
        type: string
        default: ''
      threshold_days:
        description: 'ç»­ç­¾é˜ˆå€¼å¤©æ•°'
        required: false
        type: number
        default: 5
      cert_path:
        description: 'è¯ä¹¦æ‰«æè·¯å¾„'
        required: false
        type: string
        default: '/etc/letsencrypt/live'
    secrets:
      SERVER_HOST:
        required: true
      SERVER_USERNAME:
        required: true
      SERVER_SSH_KEY:
        required: true
      SERVER_PORT:
        required: false

jobs:
  ssl-cert-management:
    name: 'åœ¨ ${{ inputs.server_name }} ä¸Šæ‰§è¡Œ SSL è¯ä¹¦ç®¡ç†'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ä¸Šä¼  SSL è¯ä¹¦ç®¡ç†è„šæœ¬'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "tools/ssl-cert-manager/cert_manager.sh"
          target: "/tmp/ssl-cert-manager/"
          strip_components: 2

      - name: 'æ‰§è¡Œ SSL è¯ä¹¦ç®¡ç†'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # æ‰“å°ä»»åŠ¡ä¿¡æ¯
            echo "ğŸš€ å¼€å§‹åœ¨æœåŠ¡å™¨ ${{ inputs.server_name }} ä¸Šæ‰§è¡Œ SSL è¯ä¹¦ç®¡ç†"
            echo "ğŸ§  æ™ºèƒ½æ¨¡å¼: æ£€æŸ¥è¯ä¹¦å¹¶æŒ‰éœ€ç»­ç­¾"
            echo "ğŸ·ï¸  ç›®æ ‡åŸŸå: ${{ inputs.domain || 'æ‰€æœ‰åŸŸå' }}"
            echo "â° ç»­ç­¾é˜ˆå€¼: ${{ inputs.threshold_days }} å¤©"
            echo "ğŸ“‚ è¯ä¹¦è·¯å¾„: ${{ inputs.cert_path }}"
            echo "----------------------------------------"
            
            # è®¾ç½®è„šæœ¬æƒé™
            chmod +x /tmp/ssl-cert-manager/cert_manager.sh
            
            # æ„å»ºå‘½ä»¤å‚æ•°
            CMD_ARGS="--threshold ${{ inputs.threshold_days }} --path ${{ inputs.cert_path }}"
            
            # å¦‚æœæŒ‡å®šäº†åŸŸåï¼Œæ·»åŠ åŸŸåå‚æ•°
            if [ -n "${{ inputs.domain }}" ]; then
              CMD_ARGS="$CMD_ARGS --domain ${{ inputs.domain }}"
            fi
            
            # æ‰§è¡Œ SSL è¯ä¹¦ç®¡ç†è„šæœ¬
            echo "ğŸ”§ æ‰§è¡Œå‘½ä»¤: /tmp/ssl-cert-manager/cert_manager.sh $CMD_ARGS"
            /tmp/ssl-cert-manager/cert_manager.sh $CMD_ARGS
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf /tmp/ssl-cert-manager/
            
            echo "âœ… SSL è¯ä¹¦ç®¡ç†ä»»åŠ¡å®Œæˆ"