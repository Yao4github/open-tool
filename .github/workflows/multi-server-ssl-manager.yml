# .github/workflows/multi-server-ssl-manager.yml
# --- å¤šæœåŠ¡å™¨ SSL ç®¡ç†å·¥ä½œæµ (ä½¿ç”¨æ–°çš„ SSL è¯ä¹¦ç®¡ç†å·¥å…·) ---
# åŒæ—¶ç®¡ç†å¤šå°æœåŠ¡å™¨çš„ SSL è¯ä¹¦

name: 'CertGuard: å¤šæœåŠ¡å™¨ SSL ç®¡ç†'

on:
  # schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨1:00 æ™ºèƒ½æ£€æŸ¥æ‰€æœ‰æœåŠ¡å™¨è¯ä¹¦å¹¶æŒ‰éœ€ç»­ç­¾
    # - cron: '0 1 * * 0'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      target_server:
        description: 'ç›®æ ‡æœåŠ¡å™¨ (all|production|staging|cdn)'
        required: false
        type: choice
        options:
          - all
          - production
          - staging
          - cdn
        default: 'all'

jobs:
  # ç”Ÿäº§æœåŠ¡å™¨
  production-server:
    if: ${{ inputs.target_server == 'all' || inputs.target_server == 'production' || github.event_name == 'schedule' }}
    uses: ./.github/workflows/reusable-ssl-cert-manager.yml
    with:
      server_name: "ç”Ÿäº§æœåŠ¡å™¨"
      threshold_days: 5
      cert_path: "/etc/letsencrypt/live"
    secrets:
      SERVER_HOST: ${{ secrets.PRODUCTION_HOST }}
      SERVER_USERNAME: ${{ secrets.PRODUCTION_USERNAME }}
      SERVER_SSH_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
      SERVER_PORT: ${{ secrets.PRODUCTION_PORT }}

  # æµ‹è¯•æœåŠ¡å™¨
  staging-server:
    if: ${{ inputs.target_server == 'all' || inputs.target_server == 'staging' || github.event_name == 'schedule' }}
    uses: ./.github/workflows/reusable-ssl-cert-manager.yml
    with:
      server_name: "æµ‹è¯•æœåŠ¡å™¨"
      threshold_days: 7  # æµ‹è¯•ç¯å¢ƒå¯ä»¥è®¾ç½®æ›´å®½æ¾çš„é˜ˆå€¼
      cert_path: "/etc/letsencrypt/live"
    secrets:
      SERVER_HOST: ${{ secrets.STAGING_HOST }}
      SERVER_USERNAME: ${{ secrets.STAGING_USERNAME }}
      SERVER_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
      SERVER_PORT: ${{ secrets.STAGING_PORT }}

  # CDN æœåŠ¡å™¨
  cdn-server:
    if: ${{ inputs.target_server == 'all' || inputs.target_server == 'cdn' || github.event_name == 'schedule' }}
    uses: ./.github/workflows/reusable-ssl-cert-manager.yml
    with:
      server_name: "CDN æœåŠ¡å™¨"
      threshold_days: 3  # CDN è¯ä¹¦æ›´æ–°é¢‘ç¹ï¼Œè®¾ç½®è¾ƒçŸ­é˜ˆå€¼
      cert_path: "/opt/ssl/certificates"  # è‡ªå®šä¹‰è¯ä¹¦è·¯å¾„
    secrets:
      SERVER_HOST: ${{ secrets.CDN_HOST }}
      SERVER_USERNAME: ${{ secrets.CDN_USERNAME }}
      SERVER_SSH_KEY: ${{ secrets.CDN_SSH_KEY }}
      SERVER_PORT: ${{ secrets.CDN_PORT }}

  # æ±‡æ€»ç»“æœå¹¶å‘é€é€šçŸ¥
  summary:
    if: always()
    needs: [production-server, staging-server, cdn-server]
    runs-on: ubuntu-latest
    steps:
      - name: 'æ±‡æ€»æ‰§è¡Œç»“æœ'
        run: |
          echo "ğŸ“ŠSSL è¯ä¹¦ç®¡ç†ä»»åŠ¡æ±‡æ€»æŠ¥å‘Š"
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          echo "æ™ºèƒ½æ¨¡å¼: æ£€æŸ¥è¯ä¹¦å¹¶æŒ‰éœ€ç»­ç­¾"
          echo "ç›®æ ‡æœåŠ¡å™¨: ${{ inputs.target_server || 'all' }}"
          echo "----------------------------------------"
          
          # æ£€æŸ¥å„æœåŠ¡å™¨æ‰§è¡ŒçŠ¶æ€
          production_status="${{ needs.production-server.result }}"
          staging_status="${{ needs.staging-server.result }}"
          cdn_status="${{ needs.cdn-server.result }}"
          
          echo "ğŸ­ ç”Ÿäº§æœåŠ¡å™¨: $production_status"
          echo "ğŸ§ª æµ‹è¯•æœåŠ¡å™¨: $staging_status"
          echo "ğŸš€ CDN æœåŠ¡å™¨: $cdn_status"
          
          # ç»Ÿè®¡ç»“æœ
          total=0
          success=0
          failed=0
          skipped=0
          
          for status in "$production_status" "$staging_status" "$cdn_status"; do
            case "$status" in
              "success") 
                ((total++))
                ((success++))
                ;;
              "failure")
                ((total++))
                ((failed++))
                ;;
              "skipped"|"")
                ((skipped++))
                ;;
            esac
          done
          
          echo "----------------------------------------"
          echo "ğŸ“ˆ æ‰§è¡Œç»Ÿè®¡:"
          echo "  æ€»è®¡: $total"
          echo "  æˆåŠŸ: $success"
          echo "  å¤±è´¥: $failed"
          echo "  è·³è¿‡: $skipped"
          
          # å¦‚æœæœ‰å¤±è´¥ï¼Œè®¾ç½®å¤±è´¥çŠ¶æ€
          if [ "$failed" -gt 0 ]; then
            echo "âŒ éƒ¨åˆ†æœåŠ¡å™¨æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æœåŠ¡å™¨æ‰§è¡ŒæˆåŠŸ"
          fi

      - name: 'å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥'
        if: failure()
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ ä¼ä¸šå¾®ä¿¡é€šçŸ¥é€»è¾‘
          echo "å‡†å¤‡å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
          # ç¤ºä¾‹ï¼šcurl -X POST "$WECHAT_WEBHOOK" -H "Content-Type: application/json" -d "{...}"