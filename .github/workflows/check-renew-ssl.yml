# .github/workflows/check-renew-ssl.yml
#
# è‡ªåŠ¨åŒ– SSL è¯ä¹¦æ£€æŸ¥ä¸ç»­ç­¾å·¥ä½œæµ (V2 - æ”¯æŒå…¨ç›˜æ‰«æ)
# æ¨¡å¼1: è‹¥æä¾› DOMAIN, åˆ™æ£€æŸ¥è¯¥ç‰¹å®šåŸŸåã€‚
# æ¨¡å¼2: è‹¥ä¸æä¾› DOMAIN, åˆ™æ‰«ææŒ‡å®šè·¯å¾„ä¸‹æ‰€æœ‰è¯ä¹¦, æ‰¾å‡ºæœ€å¿«è¿‡æœŸçš„æ¥åˆ¤æ–­ã€‚
# ==============================================================================

name: 'CertGuard: Check & Renew SSL Certificate'

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯æ—¥å‡Œæ™¨ 3:00 (UTC) æ‰§è¡Œ
  schedule:
    - cron: '0 3 * * *'

  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-Run: åªæ£€æŸ¥ä¸ç»­ç­¾ (true/false)'
        required: true
        default: 'false'
        type: boolean
      renew_threshold_days:
        description: 'ç»­ç­¾é˜ˆå€¼ (å¤©)'
        required: true
        default: '10'
        type: string

jobs:
  check-and-renew:
    name: 'Check SSL Certificate(s)'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Step 1: Print Job Information'
        run: |
          if [ -n "${{ secrets.DOMAIN }}" ]; then
            echo "ğŸš€ Starting SSL certificate check for a single domain: ${{ secrets.DOMAIN }}"
          else
            echo "ğŸš€ Starting scan for all SSL certificates..."
          fi
          echo "â° Triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ”§ Dry-Run Mode: ${{ inputs.dry_run }}"
            echo "â³ Renewal Threshold: ${{ inputs.renew_threshold_days }} days"
          else
            echo "â³ Renewal Threshold: 10 days (default)"
          fi

      - name: 'Step 2: Execute Check & Renew Script via ssh-action'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22 # å¯æ ¹æ®éœ€è¦ä¿®æ”¹
          script: |
            # å°†è¿œç¨‹è„šæœ¬å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶
            cat > /tmp/remote_check_and_renew.sh << 'EOF'
            ${{ env.REMOTE_SCRIPT }}
            EOF
            
            # èµ‹äºˆæ‰§è¡Œæƒé™å¹¶æ‰§è¡Œ
            chmod +x /tmp/remote_check_and_renew.sh
            /tmp/remote_check_and_renew.sh

        env:
          # å°† GitHub Secrets å’Œ Inputs ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™è¿œç¨‹è„šæœ¬
          DOMAIN: ${{ secrets.DOMAIN || '' }}
          CERT_PORT: ${{ secrets.CERT_PORT || '443' }}
          RENEW_CMD: ${{ secrets.RENEW_CMD }}
          RELOAD_CMD: ${{ secrets.RELOAD_CMD }}
          CERT_PATH: ${{ secrets.CERT_PATH || '' }}
          CERT_SCAN_PATH: ${{ secrets.CERT_SCAN_PATH || '/etc/letsencrypt/live' }} # æ–°å¢: å…¨ç›˜æ‰«æè·¯å¾„
          # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šå‚æ•°
          RENEW_THRESHOLD_DAYS: ${{ github.event.inputs.renew_threshold_days || '10' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          # å°†ä¸‹é¢çš„è¿œç¨‹è„šæœ¬å†…å®¹æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡
          REMOTE_SCRIPT: |
            #!/bin/bash
            #
            # è¿œç¨‹ SSL è¯ä¹¦æ£€æŸ¥ä¸ç»­ç­¾è„šæœ¬ (V2 - æ”¯æŒå…¨ç›˜æ‰«æ)
            #
            
            set -euo pipefail
            
            # --- Configuration (from environment variables) ---
            DOMAIN="${DOMAIN:-}"
            CERT_PORT="${CERT_PORT:-443}"
            RENEW_CMD="${RENEW_CMD}"
            RELOAD_CMD="${RELOAD_CMD}"
            CERT_PATH="${CERT_PATH:-}"
            CERT_SCAN_PATH="${CERT_SCAN_PATH:-/etc/letsencrypt/live}"
            RENEW_THRESHOLD_DAYS="${RENEW_THRESHOLD_DAYS:-10}"
            DRY_RUN="${DRY_RUN:-false}"
            
            # --- Helper Functions ---
            log() { echo -e "[[0;32mINFO[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
            warn() { echo -e "[[0;33mWARN[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
            error() { echo -e "[[0;31mERROR[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2; exit 1; }
            
            get_remaining_days_from_file() {
              local cert_file="$1"
              local expiry_date_str
              expiry_date_str=$(openssl x509 -enddate -noout -in "$cert_file" | cut -d= -f2)
              if [[ -z "$expiry_date_str" ]]; then echo "0"; return; fi
              local expiry_epoch
              expiry_epoch=$(date --date="$expiry_date_str" +%s)
              local current_epoch
              current_epoch=$(date +%s)
              echo $(( (expiry_epoch - current_epoch) / 86400 ))
            }

            # --- Renewal and Verification Logic ---
            perform_renewal_and_verification() {
              local initial_days="$1"
              local verification_mode="$2" # 'network' or 'file'
              local verification_target="$3" # domain name or file path
              
              if [[ "$DRY_RUN" == "true" ]]; then
                log "Dry-Run æ¨¡å¼ï¼šè·³è¿‡å®é™…ç»­ç­¾å’Œé‡è½½æ“ä½œã€‚"
                exit 0
              fi
            
              log "æ­£åœ¨æ‰§è¡Œç»­ç­¾å‘½ä»¤: $RENEW_CMD"
              if ! eval "$RENEW_CMD"; then error "è¯ä¹¦ç»­ç­¾å¤±è´¥ï¼è¯·æ£€æŸ¥ç»­ç­¾å‘½ä»¤å’Œç›¸å…³æ—¥å¿—ã€‚"; fi
              log "è¯ä¹¦ç»­ç­¾å‘½ä»¤æ‰§è¡ŒæˆåŠŸã€‚"
            
              log "æ­£åœ¨æ‰§è¡Œé‡è½½å‘½ä»¤: $RELOAD_CMD"
              if ! eval "$RELOAD_CMD"; then error "æœåŠ¡é‡è½½å¤±è´¥ï¼è¯·æ£€æŸ¥é‡è½½å‘½ä»¤å’Œç›¸å…³æ—¥å¿—ã€‚"; fi
              log "æœåŠ¡é‡è½½å‘½ä»¤æ‰§è¡ŒæˆåŠŸã€‚"
            
              log "ç­‰å¾…å‡ ç§’åè¿›è¡ŒäºŒæ¬¡æ ¡éªŒ..."
              sleep 5
              
              local new_remaining_days=0
              if [[ "$verification_mode" == "network" ]]; then
                  local expiry_date_str
                  expiry_date_str=$(echo | timeout 15 openssl s_client -servername "$verification_target" -connect "$verification_target:${CERT_PORT:-443}" 2>/dev/null | openssl x509 -enddate -noout | cut -d= -f2)
                  local expiry_epoch
                  expiry_epoch=$(date --date="$expiry_date_str" +%s)
                  local current_epoch
                  current_epoch=$(date +%s)
                  new_remaining_days=$(( (expiry_epoch - current_epoch) / 86400 ))
              else # file mode
                  new_remaining_days=$(get_remaining_days_from_file "$verification_target")
              fi

              log "ç»­ç­¾åå‰©ä½™æœ‰æ•ˆæœŸ: $new_remaining_days å¤©"
            
              if [[ "$new_remaining_days" -gt "$initial_days" ]]; then
                log "[0;32mâœ… ç»­ç­¾æˆåŠŸï¼è¯ä¹¦æœ‰æ•ˆæœŸå·²å»¶é•¿ã€‚[0m"
              else
                error "äºŒæ¬¡æ ¡éªŒå¤±è´¥ï¼ç»­ç­¾åè¯ä¹¦æœ‰æ•ˆæœŸæœªå»¶é•¿ã€‚è¯·ç«‹å³æ‰‹åŠ¨æ£€æŸ¥ï¼"
              fi
            }

            # --- Main Logic ---
            if [[ -n "$DOMAIN" ]]; then
              # --- SINGLE DOMAIN MODE ---
              log "å¯åŠ¨å•åŸŸåæ£€æµ‹æ¨¡å¼: '$DOMAIN'"
              local remaining_days
              
              if [[ -n "$CERT_PATH" && -f "$CERT_PATH" ]]; then
                log "ä½¿ç”¨æœ¬åœ°è¯ä¹¦æ¨¡å¼æ£€æµ‹: $CERT_PATH"
                remaining_days=$(get_remaining_days_from_file "$CERT_PATH")
              else
                log "ä½¿ç”¨ç½‘ç»œæ¢æµ‹æ¨¡å¼æ£€æµ‹: $DOMAIN:$CERT_PORT"
                local expiry_date_str
                expiry_date_str=$(echo | timeout 15 openssl s_client -servername "$DOMAIN" -connect "$DOMAIN:$CERT_PORT" 2>/dev/null | openssl x509 -enddate -noout | cut -d= -f2)
                if [[ -z "$expiry_date_str" ]]; then error "æ— æ³•è·å– '$DOMAIN' çš„è¯ä¹¦åˆ°æœŸæ—¥æœŸã€‚"; fi
                local expiry_epoch
                expiry_epoch=$(date --date="$expiry_date_str" +%s)
                local current_epoch
                current_epoch=$(date +%s)
                remaining_days=$(( (expiry_epoch - current_epoch) / 86400 ))
              fi

              log "åŸŸå '$DOMAIN' å‰©ä½™æœ‰æ•ˆæœŸ: $remaining_days å¤©"
              if [[ "$remaining_days" -lt "$RENEW_THRESHOLD_DAYS" ]]; then
                warn "è¯ä¹¦å‰©ä½™æœ‰æ•ˆæœŸå°äº $RENEW_THRESHOLD_DAYS å¤©ï¼Œéœ€è¦ç»­ç­¾ã€‚"
                perform_renewal_and_verification "$remaining_days" "network" "$DOMAIN"
              else
                log "[0;32mâœ… è¯ä¹¦æœ‰æ•ˆæœŸæ­£å¸¸ï¼Œæ— éœ€ç»­ç­¾ã€‚[0m"
              fi
            else
              # --- ALL DOMAINS SCAN MODE ---
              log "å¯åŠ¨å…¨ç›˜æ‰«ææ¨¡å¼ (è·¯å¾„: $CERT_SCAN_PATH)"
              if ! [ -d "$CERT_SCAN_PATH" ]; then error "è¯ä¹¦æ‰«æè·¯å¾„ '$CERT_SCAN_PATH' ä¸å­˜åœ¨æˆ–ä¸æ˜¯ä¸€ä¸ªç›®å½•ã€‚"; fi

              local min_remaining_days=9999
              local soonest_expiring_cert_file=""
              local soonest_expiring_domain=""
              
              local cert_files
              cert_files=$(find "$CERT_SCAN_PATH" -type f -name "fullchain.pem")
              if [[ -z "$cert_files" ]]; then error "åœ¨ '$CERT_SCAN_PATH' ä¸‹æœªæ‰¾åˆ°ä»»ä½• 'fullchain.pem' æ–‡ä»¶ã€‚"; fi

              while read -r cert_file; do
                  local domain_name
                  domain_name=$(basename "$(dirname "$cert_file")")
                  local current_days
                  current_days=$(get_remaining_days_from_file "$cert_file")
                  
                  if [[ "$current_days" -eq 0 ]]; then
                      warn "æ— æ³•è¯»å–è¯ä¹¦ '$domain_name' ($cert_file) çš„æœ‰æ•ˆæœŸï¼Œå·²è·³è¿‡ã€‚"
                      continue
                  fi
                  log "æ£€æµ‹åˆ°åŸŸå: '$domain_name', å‰©ä½™ $current_days å¤©ã€‚"
                  if (( current_days < min_remaining_days )); then
                      min_remaining_days=$current_days
                      soonest_expiring_cert_file="$cert_file"
                      soonest_expiring_domain="$domain_name"
                  fi
              done <<< "$cert_files"

              if [[ "$min_remaining_days" -eq 9999 ]]; then error "æ‰«æå®Œæˆï¼Œä½†æœªèƒ½æˆåŠŸè§£æä»»ä½•è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚"; fi

              log "æ‰«æå®Œæˆã€‚æœ€å¿«è¿‡æœŸçš„åŸŸåæ˜¯ '$soonest_expiring_domain'ï¼Œå‰©ä½™ $min_remaining_days å¤©ã€‚"
              if [[ "$min_remaining_days" -lt "$RENEW_THRESHOLD_DAYS" ]]; then
                warn "å­˜åœ¨è¯ä¹¦å‰©ä½™æœ‰æ•ˆæœŸå°äº $RENEW_THRESHOLD_DAYS å¤©ï¼Œéœ€è¦è§¦å‘å…¨å±€ç»­ç­¾ã€‚"
                perform_renewal_and_verification "$min_remaining_days" "file" "$soonest_expiring_cert_file"
              else
                log "[0;32mâœ… æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸæ­£å¸¸ï¼Œæ— éœ€ç»­ç­¾ã€‚[0m"
              fi
            fi
            
            exit 0