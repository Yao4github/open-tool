# .github/workflows/check-renew-ssl.yml
#
# è‡ªåŠ¨åŒ– SSL è¯ä¹¦æ£€æŸ¥ä¸ç»­ç­¾å·¥ä½œæµ (V11 - æœ€ç»ˆç‰ˆ)
# - å¹¶è¡ŒçŸ©é˜µï¼Œé…ç½®æç®€ï¼Œæ™ºèƒ½æ£€æµ‹ã€‚
# - é‡è½½é€»è¾‘æ›´æ–°ï¼šæ£€æµ‹æ‰€æœ‰æ”¯æŒçš„æœåŠ¡ (docker-nginx/nginx/apache/gost) å¹¶å…¨éƒ¨é‡è½½ã€‚
# ==============================================================================

name: 'CertGuard: Check & Renew SSL Certificates (Auto-Adaptive)'

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-Run: åªæ£€æŸ¥ä¸ç»­ç­¾ (true/false)'
        required: true
        default: 'false'
        type: boolean
      renew_threshold_days:
        description: 'ç»­ç­¾é˜ˆå€¼ (å¤©)'
        required: true
        default: '10'
        type: string

jobs:
  prepare-matrix:
    name: 'Prepare Matrix from Secrets'
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.set-matrix.outputs.hosts }}
    steps:
      - name: 'Generate Matrix from SSH_HOSTS Secret'
        id: set-matrix
        env:
          SSH_HOSTS: ${{ secrets.SSH_HOSTS }}
        run: echo "hosts=$(echo "$SSH_HOSTS" | jq -cR 'split(",")')" >> "$GITHUB_OUTPUT"

  check-and-renew:
    needs: prepare-matrix
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJSON(needs.prepare-matrix.outputs.hosts) }}

    name: 'Check SSL on ${{ matrix.host }}'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Step 1: Print Job Information'
        run: |
          echo "ğŸš€ Starting SSL certificate check for server: ${{ matrix.host }}"
          echo "â° Triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ”§ Dry-Run Mode: ${{ inputs.dry_run }}"
            echo "â³ Renewal Threshold: ${{ inputs.renew_threshold_days }} days"
          else
            echo "â³ Renewal Threshold: 10 days (default)"
          fi

      - name: 'Step 2: Execute Smart Renewal Script via ssh-action'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ matrix.host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cat > /tmp/remote_check_and_renew.sh << 'EOF'
            ${{ env.REMOTE_SCRIPT }}
            EOF
            
            chmod +x /tmp/remote_check_and_renew.sh
            /tmp/remote_check_and_renew.sh

        env:
          RENEW_THRESHOLD_DAYS: ${{ github.event.inputs.renew_threshold_days || '10' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          REMOTE_SCRIPT: |
            #!/bin/bash
            set -euo pipefail

            # --- Configuration ---
            RENEW_THRESHOLD_DAYS="${RENEW_THRESHOLD_DAYS:-10}"
            DRY_RUN="${DRY_RUN:-false}"
            CERT_SCAN_PATH="/etc/letsencrypt/live"

            # --- Helper Functions ---
            log() { echo -e "[\033[0;32mINFO\033[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
            warn() { echo -e "[\033[0;33mWARN\033[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
            error() { echo -e "[\033[0;31mERROR\033[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2; exit 1; }

            # --- Auto-detection Logic ---
            RENEW_CMD=""
            if command -v certbot &> /dev/null; then
              log "æ£€æµ‹åˆ° certbotï¼Œå°†ä½¿ç”¨ certbot è¿›è¡Œç»­ç­¾ã€‚"
              RENEW_CMD="sudo certbot renew --quiet"
            elif [ -f "$HOME/.acme.sh/acme.sh" ]; then
              log "æ£€æµ‹åˆ° acme.shï¼Œå°†ä½¿ç”¨ acme.sh è¿›è¡Œç»­ç­¾ã€‚"
              RENEW_CMD="\"$HOME/.acme.sh/acme.sh\" --renew-all --quiet"
            else
              error "æœªæ£€æµ‹åˆ° certbot æˆ– acme.shï¼Œæ— æ³•æ‰§è¡Œç»­ç­¾ã€‚"
            fi

            RELOAD_CMDS=""
            if command -v docker &> /dev/null && docker ps --filter "name=nginx" --format "{{.ID}}" | grep -q .; then
              nginx_container=$(docker ps -q --filter "name=nginx" | head -n 1)
              log "æ£€æµ‹åˆ°åä¸º 'nginx' çš„ Docker å®¹å™¨ (ID: $nginx_container)ï¼Œæ·»åŠ é‡è½½å‘½ä»¤ã€‚"
              RELOAD_CMDS+="docker exec ${nginx_container} nginx -s reload;"
            fi
            if systemctl list-units --type=service --state=running | grep -q 'nginx.service'; then
              log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ nginx.serviceï¼Œæ·»åŠ é‡è½½å‘½ä»¤ã€‚"
              RELOAD_CMDS+="sudo systemctl reload nginx;"
            fi
            if systemctl list-units --type=service --state=running | grep -q 'apache2.service'; then
              log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ apache2.serviceï¼Œæ·»åŠ é‡è½½å‘½ä»¤ã€‚"
              RELOAD_CMDS+="sudo systemctl reload apache2;"
            elif systemctl list-units --type=service --state=running | grep -q 'httpd.service'; then
              log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ httpd.serviceï¼Œæ·»åŠ é‡è½½å‘½ä»¤ã€‚"
              RELOAD_CMDS+="sudo systemctl reload httpd;"
            fi
            if systemctl list-units --type=service --state=running | grep -q 'gost.service'; then
              log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ gost.serviceï¼Œæ·»åŠ é‡è½½å‘½ä»¤ã€‚"
              RELOAD_CMDS+="sudo systemctl reload gost;"
            fi

            if [ -z "${RELOAD_CMDS}" ]; then
              error "æœªæ£€æµ‹åˆ°ä»»ä½•æ”¯æŒçš„æœåŠ¡ (Docker Nginx, Nginx, Apache, Gost)ï¼Œæ— æ³•æ‰§è¡Œé‡è½½ã€‚"
            fi

            # --- Core Logic ---
            get_remaining_days_from_file() {
              local cert_file="$1"
              local expiry_date_str
              expiry_date_str=$(openssl x509 -enddate -noout -in "$cert_file" | cut -d= -f2)
              if [[ -z "$expiry_date_str" ]]; then echo "0"; return; fi
              local expiry_epoch
              expiry_epoch=$(date --date="$expiry_date_str" +%s)
              local current_epoch
              current_epoch=$(date +%s)
              echo $(( (expiry_epoch - current_epoch) / 86400 ))
            }

            log "å¯åŠ¨å…¨ç›˜æ‰«ææ¨¡å¼ (è·¯å¾„: $CERT_SCAN_PATH)"
            if ! [ -d "$CERT_SCAN_PATH" ]; then error "è¯ä¹¦æ‰«æè·¯å¾„ '$CERT_SCAN_PATH' ä¸å­˜åœ¨æˆ–ä¸æ˜¯ä¸€ä¸ªç›®å½•ã€‚"; fi

            local min_remaining_days=9999
            local soonest_expiring_cert_file=""
            local soonest_expiring_domain=""
            
            local cert_files
            cert_files=$(find "$CERT_SCAN_PATH" -type f -name "fullchain.pem")
            if [[ -z "$cert_files" ]]; then
              log "åœ¨ '$CERT_SCAN_PATH' ä¸‹æœªæ‰¾åˆ°ä»»ä½• 'fullchain.pem' æ–‡ä»¶ã€‚ä»»åŠ¡æ­£å¸¸ç»“æŸã€‚"
              exit 0
            fi

            while read -r cert_file; do
                local domain_name
                domain_name=$(basename "$(dirname "$cert_file")")
                local current_days
                current_days=$(get_remaining_days_from_file "$cert_file")
                if [[ "$current_days" -eq 0 ]]; then
                    warn "æ— æ³•è¯»å–è¯ä¹¦ '$domain_name' ($cert_file) çš„æœ‰æ•ˆæœŸï¼Œå·²è·³è¿‡ã€‚"
                    continue
                fi
                log "æ£€æµ‹åˆ°åŸŸå: '$domain_name', å‰©ä½™ $current_days å¤©ã€‚"
                if (( current_days < min_remaining_days )); then
                    min_remaining_days=$current_days
                    soonest_expiring_cert_file="$cert_file"
                    soonest_expiring_domain="$domain_name"
                fi
            done <<< "$cert_files"

            if [[ "$min_remaining_days" -eq 9999 ]]; then error "æ‰«æå®Œæˆï¼Œä½†æœªèƒ½æˆåŠŸè§£æä»»ä½•è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚"; fi

            log "æ‰«æå®Œæˆã€‚æœ€å¿«è¿‡æœŸçš„åŸŸåæ˜¯ '$soonest_expiring_domain'ï¼Œå‰©ä½™ $min_remaining_days å¤©ã€‚"
            if [[ "$min_remaining_days" -lt "$RENEW_THRESHOLD_DAYS" ]]; then
              warn "å­˜åœ¨è¯ä¹¦å‰©ä½™æœ‰æ•ˆæœŸå°äº $RENEW_THRESHOLD_DAYS å¤©ï¼Œéœ€è¦è§¦å‘å…¨å±€ç»­ç­¾ã€‚"
              if [[ "$DRY_RUN" == "true" ]]; then
                log "Dry-Run æ¨¡å¼ï¼šè·³è¿‡å®é™…ç»­ç­¾å’Œé‡è½½æ“ä½œã€‚"
                exit 0
              fi
              log "æ­£åœ¨æ‰§è¡Œç»­ç­¾å‘½ä»¤: $RENEW_CMD"
              if ! eval "$RENEW_CMD"; then error "è¯ä¹¦ç»­ç­¾å¤±è´¥ï¼è¯·æ£€æŸ¥ç»­ç­¾å‘½ä»¤å’Œç›¸å…³æ—¥å¿—ã€‚"; fi
              log "è¯ä¹¦ç»­ç­¾å‘½ä»¤æ‰§è¡ŒæˆåŠŸã€‚"
              log "æ­£åœ¨æ‰§è¡Œé‡è½½å‘½ä»¤..."
              if ! eval "$RELOAD_CMDS"; then error "æœåŠ¡é‡è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç›¸å…³æ—¥å¿—ã€‚"; fi
              log "æ‰€æœ‰æ£€æµ‹åˆ°çš„æœåŠ¡å‡å·²é‡è½½ã€‚"
              log "ç­‰å¾…å‡ ç§’åè¿›è¡ŒäºŒæ¬¡æ ¡éªŒ..."
              sleep 5
              local new_remaining_days
              new_remaining_days=$(get_remaining_days_from_file "$soonest_expiring_cert_file")
              log "ç»­ç­¾å '$soonest_expiring_domain' å‰©ä½™æœ‰æ•ˆæœŸ: $new_remaining_days å¤©"
              if [[ "$new_remaining_days" -gt "$min_remaining_days" ]]; then
                log "\033[0;32mâœ… ç»­ç­¾æˆåŠŸï¼è¯ä¹¦æœ‰æ•ˆæœŸå·²å»¶é•¿ã€‚\033[0m"
              else
                error "äºŒæ¬¡æ ¡éªŒå¤±è´¥ï¼ç»­ç­¾åè¯ä¹¦æœ‰æ•ˆæœŸæœªå»¶é•¿ã€‚è¯·ç«‹å³æ‰‹åŠ¨æ£€æŸ¥ï¼"
              fi
            else
              log "\033[0;32mâœ… æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸæ­£å¸¸ï¼Œæ— éœ€ç»­ç­¾ã€‚\033[0m"
            fi
            exit 0
