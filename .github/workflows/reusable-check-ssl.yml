# .github/workflows/reusable-check-ssl.yml
# --- å­å·¥ä½œæµ (å¯å¤ç”¨) ---
# åŒ…å«æ‰€æœ‰å®é™…æ“ä½œé€»è¾‘

name: 'Reusable: æ£€æŸ¥å¹¶ç»­ç­¾ SSL è¯ä¹¦'

on:
  workflow_call:
    inputs:
      server_name:
        description: 'æœåŠ¡å™¨çš„åç§°'
        required: true
        type: string
    secrets:
      SERVER_HOST:
        required: true
      SERVER_USERNAME:
        required: true
      SERVER_SSH_KEY:
        required: true
      SERVER_PORT:
        required: true

jobs:
  check-and-renew:
    name: 'åœ¨ ${{ inputs.server_name }} ä¸Šæ£€æŸ¥ SSL'
    runs-on: ubuntu-latest
    steps:
      - name: 'æ­¥éª¤ 1: æ‰“å°ä»»åŠ¡ä¿¡æ¯'
        run: |
          echo "ğŸš€ å¼€å§‹ä¸ºæœåŠ¡å™¨ ${{ inputs.server_name }} æ£€æŸ¥ SSL è¯ä¹¦"

      - name: 'æ­¥éª¤ 2: é€šè¿‡ SSH æ‰§è¡Œæ™ºèƒ½ç»­ç­¾è„šæœ¬'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cat > /tmp/remote_check_and_renew.sh << 'EOF'
            ${{ env.REMOTE_SCRIPT }}
            EOF
            
            chmod +x /tmp/remote_check_and_renew.sh
            /tmp/remote_check_and_renew.sh
        env:
          RENEW_THRESHOLD_DAYS: '10' # ç»­ç­¾é˜ˆå€¼å›ºå®šä¸º10å¤©
          REMOTE_SCRIPT: |
            #!/bin/bash
            set -euo pipefail

            # --- Configuration ---
            RENEW_THRESHOLD_DAYS="${RENEW_THRESHOLD_DAYS:-10}"
            CERT_SCAN_PATH="/etc/letsencrypt/live"

            # --- Helper Functions ---
            log() { echo -e "[\033[0;32mINFO\033[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
            warn() { echo -e "[\033[0;33mWARN\033[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
            error() { echo -e "[\033[0;31mERROR\033[0m] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2; exit 1; }
            step_start() { log "=== å¼€å§‹æ‰§è¡Œ: $1 ==="; }
            step_end() { log "=== å®Œæˆæ‰§è¡Œ: $1 ===\n"; }

            # --- Auto-detection Logic ---
            step_start "æ£€æµ‹è¯ä¹¦ç®¡ç†å·¥å…·"
            RENEW_CMD=""
            if command -v certbot &> /dev/null; then
              log "æ£€æµ‹åˆ° certbotï¼Œå°†ä½¿ç”¨ certbot è¿›è¡Œç»­ç­¾ã€‚"
              RENEW_CMD="sudo certbot renew --quiet"
            elif [ -f "$HOME/.acme.sh/acme.sh" ]; then
              log "æ£€æµ‹åˆ° acme.shï¼Œå°†ä½¿ç”¨ acme.sh è¿›è¡Œç»­ç­¾ã€‚"
              RENEW_CMD="\"$HOME/.acme.sh/acme.sh\" --renew-all --quiet"
            else
              error "æœªæ£€æµ‹åˆ° certbot æˆ– acme.shï¼Œæ— æ³•æ‰§è¡Œç»­ç­¾ã€‚"
            fi
            step_end "æ£€æµ‹è¯ä¹¦ç®¡ç†å·¥å…·"

            step_start "æ£€æµ‹éœ€è¦é‡è½½çš„æœåŠ¡"
            # åˆå§‹åŒ–é‡è½½å‘½ä»¤æ•°ç»„
            RELOAD_CMDS=""

            # æ£€æµ‹ Docker å®¹å™¨ï¼ˆæ”¯æŒä¸åŒçš„å‘½åæ–¹å¼ï¼‰
            if command -v docker &> /dev/null; then
              step_start "Docker ç¯å¢ƒæ£€æµ‹"
              log "æ£€æµ‹åˆ° Docker ç¯å¢ƒï¼Œå¼€å§‹æœç´¢ Nginx å®¹å™¨..."
              # ä½¿ç”¨æ•°ç»„å­˜å‚¨ç»“æœï¼Œé¿å…ç®¡é“å­shellé—®é¢˜
              mapfile -t containers < <(docker ps --format "{{.ID}} {{.Names}}" | grep -iE 'nginx|proxy' || true)
              for container in "${containers[@]}"; do
                container_id=$(echo "$container" | cut -d' ' -f1)
                container_name=$(echo "$container" | cut -d' ' -f2-)
                if docker exec "$container_id" which nginx &> /dev/null; then
                  log "æ£€æµ‹åˆ° Nginx Docker å®¹å™¨: $container_name (ID: $container_id)"
                  RELOAD_CMDS+="docker exec $container_id nginx -s reload;"
                fi
              done
              if [ ${#containers[@]} -eq 0 ]; then
                log "æœªæ‰¾åˆ°ä»»ä½• Nginx ç›¸å…³çš„ Docker å®¹å™¨"
              fi
              step_end "Docker ç¯å¢ƒæ£€æµ‹"
            fi

            # æ£€æµ‹ç³»ç»ŸæœåŠ¡ï¼ˆsystemdï¼‰
            if command -v systemctl &> /dev/null; then
              step_start "Systemd æœåŠ¡æ£€æµ‹"
              # Nginx æ£€æµ‹
              for service in nginx nginx-full openresty; do
                if systemctl is-active --quiet "$service"; then
                  log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ $service æœåŠ¡"
                  RELOAD_CMDS+="sudo systemctl reload $service;"
                fi
              done

              # Apache æ£€æµ‹
              for service in apache2 httpd apache; do
                if systemctl is-active --quiet "$service"; then
                  log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ $service æœåŠ¡"
                  RELOAD_CMDS+="sudo systemctl reload $service;"
                fi
              done

              # å…¶ä»–ä»£ç†æœåŠ¡æ£€æµ‹
              for service in caddy haproxy traefik gost; do
                if systemctl is-active --quiet "$service"; then
                  log "æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ $service æœåŠ¡"
                  if [ "$service" = "gost" ]; then
                    RELOAD_CMDS+="sudo systemctl restart $service;"  # gost é€šå¸¸æ²¡æœ‰ reload
                  else
                    RELOAD_CMDS+="sudo systemctl reload $service;"
                  fi
                fi
              done
              step_end "Systemd æœåŠ¡æ£€æµ‹"
            fi

            # æ£€æµ‹è¿›ç¨‹ï¼ˆé systemdï¼‰
            if ! command -v systemctl &> /dev/null; then
              step_start "ä¼ ç»Ÿè¿›ç¨‹æ£€æµ‹"
              if pgrep -f "nginx: master process" > /dev/null; then
                log "æ£€æµ‹åˆ° Nginx ä¸»è¿›ç¨‹"
                RELOAD_CMDS+="sudo nginx -s reload;"
              fi
              
              if pgrep -f "apache2" > /dev/null || pgrep -f "httpd" > /dev/null; then
                if [ -f "/etc/debian_version" ]; then
                  log "æ£€æµ‹åˆ° Apache2 è¿›ç¨‹ (Debian/Ubuntu)"
                  RELOAD_CMDS+="sudo apache2ctl graceful;"
                else
                  log "æ£€æµ‹åˆ° HTTPD è¿›ç¨‹ (RHEL/CentOS)"
                  RELOAD_CMDS+="sudo apachectl graceful;"
                fi
              fi
              step_end "ä¼ ç»Ÿè¿›ç¨‹æ£€æµ‹"
            fi

            # ç§»é™¤æœ€åä¸€ä¸ªåˆ†å·
            RELOAD_CMDS="${RELOAD_CMDS%;}"

            if [ -z "${RELOAD_CMDS}" ]; then
              error "æœªæ£€æµ‹åˆ°ä»»ä½•æ”¯æŒçš„æœåŠ¡ (Docker Nginx, Nginx, Apache, Gost)ï¼Œæ— æ³•æ‰§è¡Œé‡è½½ã€‚"
            fi

            step_end "æ£€æµ‹éœ€è¦é‡è½½çš„æœåŠ¡"

            # --- Core Logic ---
            step_start "è¯ä¹¦æ‰«æå’Œæœ‰æ•ˆæœŸæ£€æŸ¥"
            get_remaining_days_from_file() {
              local cert_file="$1"
              local expiry_date_str
              expiry_date_str=$(openssl x509 -enddate -noout -in "$cert_file" | cut -d= -f2)
              if [[ -z "$expiry_date_str" ]]; then echo "0"; return; fi
              local expiry_epoch
              expiry_epoch=$(date --date="$expiry_date_str" +%s)
              local current_epoch
              current_epoch=$(date +%s)
              echo $(( (expiry_epoch - current_epoch) / 86400 ))
            }

            log "å¯åŠ¨å…¨ç›˜æ‰«ææ¨¡å¼ (è·¯å¾„: $CERT_SCAN_PATH)"
            if ! [ -d "$CERT_SCAN_PATH" ]; then error "è¯ä¹¦æ‰«æè·¯å¾„ '$CERT_SCAN_PATH' ä¸å­˜åœ¨æˆ–ä¸æ˜¯ä¸€ä¸ªç›®å½•ã€‚"; fi

            min_remaining_days=9999
            soonest_expiring_cert_file=""
            soonest_expiring_domain=""
            
            cert_files=$(find "$CERT_SCAN_PATH" -type d -maxdepth 1 -mindepth 1 2>/dev/null | while read -r domain_dir; do
              if [[ -f "$domain_dir/fullchain.pem" ]]; then
                echo "$domain_dir/fullchain.pem"
              fi
            done)

            if [[ -z "$cert_files" ]]; then
              log "åœ¨ '$CERT_SCAN_PATH' çš„å­ç›®å½•ä¸­æœªæ‰¾åˆ°ä»»ä½• 'fullchain.pem' æ–‡ä»¶ã€‚"
              # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•åŸŸåç›®å½•
              domain_count=$(find "$CERT_SCAN_PATH" -type d -maxdepth 1 -mindepth 1 2>/dev/null | wc -l)
              if [ "$domain_count" -eq 0 ]; then
                warn "åœ¨ '$CERT_SCAN_PATH' ä¸‹æœªæ‰¾åˆ°ä»»ä½•åŸŸåç›®å½•ã€‚"
              else
                warn "æ‰¾åˆ° $domain_count ä¸ªåŸŸåç›®å½•ï¼Œä½†éƒ½ä¸åŒ…å«æœ‰æ•ˆçš„è¯ä¹¦æ–‡ä»¶ã€‚"
              fi
              exit 0
            fi

            while read -r cert_file; do
                domain_name=$(basename "$(dirname "$cert_file")")
                current_days=$(get_remaining_days_from_file "$cert_file")
                if [[ "$current_days" -eq 0 ]]; then
                    warn "æ— æ³•è¯»å–è¯ä¹¦ '$domain_name' ($cert_file) çš„æœ‰æ•ˆæœŸï¼Œå·²è·³è¿‡ã€‚"
                    continue
                fi
                log "æ£€æµ‹åˆ°åŸŸå: '$domain_name', å‰©ä½™ $current_days å¤©ã€‚"
                if (( current_days < min_remaining_days )); then
                    min_remaining_days=$current_days
                    soonest_expiring_cert_file="$cert_file"
                    soonest_expiring_domain="$domain_name"
                fi
            done <<< "$cert_files"

            if [[ "$min_remaining_days" -eq 9999 ]]; then error "æ‰«æå®Œæˆï¼Œä½†æœªèƒ½æˆåŠŸè§£æä»»ä½•è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚"; fi

            log "æ‰«æå®Œæˆã€‚æœ€å¿«è¿‡æœŸçš„åŸŸåæ˜¯ '$soonest_expiring_domain'ï¼Œå‰©ä½™ $min_remaining_days å¤©ã€‚"
            step_end "è¯ä¹¦æ‰«æå’Œæœ‰æ•ˆæœŸæ£€æŸ¥"
            if [[ "$min_remaining_days" -lt "$RENEW_THRESHOLD_DAYS" ]]; then
              warn "å­˜åœ¨è¯ä¹¦å‰©ä½™æœ‰æ•ˆæœŸå°äº $RENEW_THRESHOLD_DAYS å¤©ï¼Œéœ€è¦è§¦å‘å…¨å±€ç»­ç­¾ã€‚"
              step_start "è¯ä¹¦ç»­ç­¾æµç¨‹"
              log "æ­£åœ¨æ‰§è¡Œç»­ç­¾å‘½ä»¤: $RENEW_CMD"
              if ! eval "$RENEW_CMD"; then error "è¯ä¹¦ç»­ç­¾å¤±è´¥ï¼è¯·æ£€æŸ¥ç»­ç­¾å‘½ä»¤å’Œç›¸å…³æ—¥å¿—ã€‚"; fi
              log "è¯ä¹¦ç»­ç­¾å‘½ä»¤æ‰§è¡ŒæˆåŠŸã€‚"
              log "æ­£åœ¨æ‰§è¡Œé‡è½½å‘½ä»¤..."
              if ! eval "$RELOAD_CMDS"; then error "æœåŠ¡é‡è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç›¸å…³æ—¥å¿—ã€‚"; fi
              log "æ‰€æœ‰æ£€æµ‹åˆ°çš„æœåŠ¡å‡å·²é‡è½½ã€‚"
              log "ç­‰å¾…å‡ ç§’åè¿›è¡ŒäºŒæ¬¡æ ¡éªŒ..."
              sleep 5
              new_remaining_days=$(get_remaining_days_from_file "$soonest_expiring_cert_file")
              log "ç»­ç­¾å '$soonest_expiring_domain' å‰©ä½™æœ‰æ•ˆæœŸ: $new_remaining_days å¤©"
              if [[ "$new_remaining_days" -gt "$min_remaining_days" ]]; then
                log "\033[0;32mâœ… ç»­ç­¾æˆåŠŸï¼è¯ä¹¦æœ‰æ•ˆæœŸå·²å»¶é•¿ã€‚\033[0m"
              else
                error "äºŒæ¬¡æ ¡éªŒå¤±è´¥ï¼ç»­ç­¾åè¯ä¹¦æœ‰æ•ˆæœŸæœªå»¶é•¿ã€‚è¯·ç«‹å³æ‰‹åŠ¨æ£€æŸ¥ï¼"
              fi
              step_end "è¯ä¹¦ç»­ç­¾æµç¨‹"
            else
              log "\033[0;32mâœ… æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸæ­£å¸¸ï¼Œæ— éœ€ç»­ç­¾ã€‚\033[0m"
            fi
            exit 0
